let r,p=null;function d(){return(p===null||p.byteLength===0)&&(p=new Uint8Array(r.memory.buffer)),p}let w=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});w.decode();const O=2146435072;let b=0;function F(n,e){return b+=e,b>=O&&(w=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),w.decode(),b=e),w.decode(d().subarray(n,n+e))}function h(n,e){return n=n>>>0,F(n,e)}function u(n,e){return n=n>>>0,d().subarray(n/1,n/1+e)}function I(n){const e=r.__externref_table_alloc();return r.__wbindgen_externrefs.set(e,n),e}function L(n,e){try{return n.apply(this,e)}catch(t){const s=I(t);r.__wbindgen_exn_store(s)}}let v=0;const m=new TextEncoder;"encodeInto"in m||(m.encodeInto=function(n,e){const t=m.encode(n);return e.set(t),{read:n.length,written:t.length}});function U(n,e,t){if(t===void 0){const _=m.encode(n),l=e(_.length,1)>>>0;return d().subarray(l,l+_.length).set(_),v=_.length,l}let s=n.length,i=e(s,1)>>>0;const o=d();let a=0;for(;a<s;a++){const _=n.charCodeAt(a);if(_>127)break;o[i+a]=_}if(a!==s){a!==0&&(n=n.slice(a)),i=t(i,s,s=a+n.length*3,1)>>>0;const _=d().subarray(i+a,i+s),l=m.encodeInto(n,_);a+=l.written,i=t(i,s,a,1)>>>0}return v=a,i}let c=null;function T(){return(c===null||c.buffer.detached===!0||c.buffer.detached===void 0&&c.buffer!==r.memory.buffer)&&(c=new DataView(r.memory.buffer)),c}function y(n){const e=r.__wbindgen_externrefs.get(n);return r.__externref_table_dealloc(n),e}const S=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>r.__wbg_game_free(n>>>0,1));class g{static __wrap(e){e=e>>>0;const t=Object.create(g.prototype);return t.__wbg_ptr=e,S.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,S.unregister(this),e}free(){const e=this.__destroy_into_raw();r.__wbg_game_free(e,0)}get_visits(){return r.game_get_visits(this.__wbg_ptr)}place_info(e){const t=r.game_place_info(this.__wbg_ptr,e);return f.__wrap(t)}is_drafting(){return r.game_is_drafting(this.__wbg_ptr)!==0}take_action(){const e=r.game_take_action(this.__wbg_ptr);if(e[1])throw y(e[0])}move_penguin(e,t){const s=r.game_move_penguin(this.__wbg_ptr,e,t);if(s[1])throw y(s[0])}active_player(){const e=r.game_active_player(this.__wbg_ptr);return e===16777215?void 0:e}place_penguin(e){const t=r.game_place_penguin(this.__wbg_ptr,e);if(t[1])throw y(t[0])}possible_moves(e){const t=r.game_possible_moves(this.__wbg_ptr,e);var s=u(t[0],t[1]).slice();return r.__wbindgen_free(t[0],t[1]*1,1),s}draftable_cells(){const e=r.game_draftable_cells(this.__wbg_ptr);var t=u(e[0],e[1]).slice();return r.__wbindgen_free(e[0],e[1]*1,1),t}playout_n_times(e){r.game_playout_n_times(this.__wbg_ptr,e)}finished_drafting(){return r.game_finished_drafting(this.__wbg_ptr)!==0}get_total_playouts(){return r.game_get_total_playouts(this.__wbg_ptr)>>>0}static new(){const e=r.game_new();return g.__wrap(e)}turn(){return r.game_turn(this.__wbg_ptr)>>>0}score(e){return r.game_score(this.__wbg_ptr,e)>>>0}claimed(e){const t=r.game_claimed(this.__wbg_ptr,e);var s=u(t[0],t[1]).slice();return r.__wbindgen_free(t[0],t[1]*1,1),s}playout(){r.game_playout(this.__wbg_ptr)}num_fish(e){return r.game_num_fish(this.__wbg_ptr,e)>>>0}penguins(e){const t=r.game_penguins(this.__wbg_ptr,e);var s=u(t[0],t[1]).slice();return r.__wbindgen_free(t[0],t[1]*1,1),s}game_over(){return r.game_game_over(this.__wbg_ptr)!==0}move_info(e,t){const s=r.game_move_info(this.__wbg_ptr,e,t);return f.__wrap(s)}tree_size(){return r.game_tree_size(this.__wbg_ptr)>>>0}}Symbol.dispose&&(g.prototype[Symbol.dispose]=g.prototype.free);const M=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>r.__wbg_moveinfo_free(n>>>0,1));class f{static __wrap(e){e=e>>>0;const t=Object.create(f.prototype);return t.__wbg_ptr=e,M.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,M.unregister(this),e}free(){const e=this.__destroy_into_raw();r.__wbg_moveinfo_free(e,0)}get_visits(){return r.moveinfo_get_visits(this.__wbg_ptr)}get_rewards(){return r.moveinfo_get_rewards(this.__wbg_ptr)}}Symbol.dispose&&(f.prototype[Symbol.dispose]=f.prototype.free);const D=new Set(["basic","cors","default"]);async function W(n,e){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,e)}catch(s){if(n.ok&&D.has(n.type)&&n.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",s);else throw s}const t=await n.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(n,e);return t instanceof WebAssembly.Instance?{instance:t,module:n}:t}}function C(){const n={};return n.wbg={},n.wbg.__wbg___wbindgen_throw_b855445ff6a94295=function(e,t){throw new Error(h(e,t))},n.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let s,i;try{s=e,i=t,console.error(h(e,t))}finally{r.__wbindgen_free(s,i,1)}},n.wbg.__wbg_getRandomValues_1c61fac11405ffdc=function(){return L(function(e,t){globalThis.crypto.getRandomValues(u(e,t))},arguments)},n.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},n.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const s=t.stack,i=U(s,r.__wbindgen_malloc,r.__wbindgen_realloc),o=v;T().setInt32(e+4,o,!0),T().setInt32(e+0,i,!0)},n.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,t){return h(e,t)},n.wbg.__wbindgen_init_externref_table=function(){const e=r.__wbindgen_externrefs,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},n}function N(n,e){return r=n.exports,x.__wbindgen_wasm_module=e,c=null,p=null,r.__wbindgen_start(),r}async function x(n){if(r!==void 0)return r;typeof n<"u"&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof n>"u"&&(n=new URL(""+new URL("htmf_wasm_bg-DP8oI7RD.wasm",import.meta.url).href,import.meta.url));const e=C();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:t,module:s}=await W(await n,e);return N(t,s)}const z=2,Y=0,P=1,E=8,j=7,B=8,V=j*(E/2)+B*(E/2),A=200,R=14e3,k=12e4;function G(n){const e=[];for(let o=0;o<V;++o)e.push(n.num_fish(o));const t=[],s=[],i=[];for(let o=0;o<z;++o)t.push(n.score(o)),s.push([...n.penguins(o)]),i.push([...n.claimed(o)]);return{activePlayer:n.active_player(),modeType:n.finished_drafting()?"playing":"drafting",scores:t,turn:n.turn(),board:{fish:e,penguins:s,claimed:i}}}function X(n,e){if(n.active_player()!==Y)return[];if(n.finished_drafting()){if(e!==void 0)return[...n.possible_moves(e)];const t=n.active_player();return t===void 0?[]:[...n.penguins(t)]}else return[...n.draftable_cells()]}class H{wasmInternals;game=g.new();postMessage;ponderer;ponderStartTime;totalCompletedPonderTimeMs=0;constructor(e,t){this.wasmInternals=e,this.postMessage=t,this.ponder(),this.postGameState({})}free(){this.stopPondering(),this.game.free(),this.totalCompletedPonderTimeMs=0}ponder(){this.ponderer===void 0&&(this.ponderStartTime=performance.now(),this.ponderer=self.setInterval(()=>{const e=this.game.active_player();if(this.game.get_visits()>=k||e===P){this.stopPondering();return}this.game.playout_n_times(A),e!==void 0&&this.postThinkingProgress({activePlayer:e,playoutsNeeded:k})}))}stopPondering(){this.ponderer!==void 0&&(clearInterval(this.ponderer),this.ponderer=void 0),this.ponderStartTime!==void 0&&(this.totalCompletedPonderTimeMs+=performance.now()-this.ponderStartTime,this.ponderStartTime=void 0)}placePenguin(e){this.game.place_penguin(e),this.ponder()}movePenguin(e,t){this.game.move_penguin(e,t),this.ponder()}playout(){this.game.playout()}takeAction(){const e=this.game.turn()<2?2*R:R;let t=performance.now();for(;this.game.get_visits()<e;){this.game.playout_n_times(A),this.totalCompletedPonderTimeMs+=performance.now()-t,t=performance.now();const s=this.game.active_player();s!==void 0&&this.postThinkingProgress({activePlayer:s,playoutsNeeded:e})}this.totalCompletedPonderTimeMs+=performance.now()-t,t=performance.now(),this.game.take_action(),this.postGameState({}),this.ponder()}getState(){return G(this.game)}getPossibleMoves(e){return X(this.game,e)}onMessage(e){console.log(`received request ${e.type}`);let t,s=!1;switch(e.type){case"getGameState":break;case"movePenguin":try{e.src===void 0?this.placePenguin(e.dst):this.movePenguin(e.src,e.dst)}catch{s=!0}break;case"getPossibleMoves":t=e.src;break}for(this.postGameState({src:t,lastMoveWasIllegal:s});this.game.active_player()===P;)this.takeAction()}postGameState({src:e,lastMoveWasIllegal:t}){t=t===!0;const s=this.postMessage;s({type:"gameState",gameState:this.getState(),possibleMoves:this.getPossibleMoves(e),lastMoveWasIllegal:t})}postThinkingProgress({activePlayer:e,playoutsNeeded:t}){const s=this.postMessage;s({type:"thinkingProgress",completed:this.game.get_visits(),required:t,totalPlayouts:this.game.get_total_playouts(),totalTimeThinkingMs:this.getTotalTimeThinkingMs(),memoryUsage:this.wasmInternals.memory.buffer.byteLength,treeSize:this.game.tree_size(),playerMoveScores:{player:e,moveScores:this.getMoveScores(e)}})}getMoveScores(e){const t=[];if(this.game.is_drafting())for(const s of this.game.draftable_cells()){const i=this.game.place_info(s);t.push({dst:s,visits:i.get_visits(),rewards:i.get_rewards()})}else for(const s of this.game.penguins(e))for(const i of this.game.possible_moves(s)){const o=this.game.move_info(s,i);t.push({src:s,dst:i,visits:o.get_visits(),rewards:o.get_rewards()})}return t}getTotalTimeThinkingMs(){let e=this.totalCompletedPonderTimeMs;return this.ponderStartTime!==void 0&&(e+=performance.now()-this.ponderStartTime),e}}const K=await x(),Z=new H(K,postMessage);onmessage=n=>{Z.onMessage(n.data)};
//# sourceMappingURL=bot.worker-B6Lp3EKh.js.map
